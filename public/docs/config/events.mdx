
# Sistema de Eventos

O HelperDB inclui um sistema completo de eventos baseado no EventEmitter que permite monitoramento em tempo real de todas as operaÃ§Ãµes.

## ConfiguraÃ§Ã£o

```javascript
const { HelperDB } = require('helper.db');

const db = new HelperDB({
    driver: 'sqlite',
    filePath: './data.sqlite',
    events: {
        enabled: true,
        maxListeners: 100,
        async: true,
        buffer: {
            enabled: true,
            maxSize: 1000,
            flushInterval: 5000 // 5 segundos
        }
    }
});
```

## Eventos BÃ¡sicos

### OperaÃ§Ãµes de Dados
```javascript
// Evento de escrita
db.on('set', (key, value, options) => {
    console.log(`ðŸ“ Dados salvos: ${key}`, value);
});

// Evento de leitura
db.on('get', (key, value) => {
    console.log(`ðŸ“– Dados lidos: ${key}`, value);
});

// Evento de exclusÃ£o
db.on('delete', (key, existed) => {
    console.log(`ðŸ—‘ï¸ Dados removidos: ${key} (existia: ${existed})`);
});

// Evento de verificaÃ§Ã£o
db.on('has', (key, exists) => {
    console.log(`ðŸ” VerificaÃ§Ã£o: ${key} (existe: ${exists})`);
});
```

### OperaÃ§Ãµes MatemÃ¡ticas
```javascript
// AdiÃ§Ã£o
db.on('add', (key, value, result) => {
    console.log(`âž• Soma: ${key} + ${value} = ${result}`);
});

// SubtraÃ§Ã£o
db.on('sub', (key, value, result) => {
    console.log(`âž– SubtraÃ§Ã£o: ${key} - ${value} = ${result}`);
});
```

## Eventos de Sistema

### ConexÃ£o e InicializaÃ§Ã£o
```javascript
db.on('connected', (driver, config) => {
    console.log(`ðŸ”— Conectado ao ${driver}`);
});

db.on('ready', () => {
    console.log('âœ… Database pronto para uso');
});

db.on('error', (error) => {
    console.error('âŒ Erro no database:', error);
});
```

### Performance e EstatÃ­sticas
```javascript
db.on('performance', (stats) => {
    console.log('ðŸ“Š EstatÃ­sticas:', stats);
    // {
    //   operation: 'get',
    //   duration: 15, // ms
    //   cacheHit: true,
    //   key: 'user:1'
    // }
});

db.on('slow_query', (operation, duration, key) => {
    console.warn(`ðŸŒ Query lenta: ${operation} (${duration}ms) - ${key}`);
});
```

## Eventos de Cache

```javascript
// Cache hit
db.on('cache:hit', (key) => {
    console.log(`âš¡ Cache hit: ${key}`);
});

// Cache miss
db.on('cache:miss', (key) => {
    console.log(`ðŸ’¾ Cache miss: ${key}`);
});

// Cache invalidaÃ§Ã£o
db.on('cache:invalidate', (key) => {
    console.log(`ðŸ§¹ Cache limpo: ${key}`);
});

// EstatÃ­sticas do cache
db.on('cache:stats', (stats) => {
    console.log('ðŸ“ˆ Cache stats:', stats);
});
```

## Eventos de Backup

```javascript
// Backup iniciado
db.on('backup:started', (info) => {
    console.log('ðŸ’¾ Backup iniciado:', info);
});

// Backup concluÃ­do
db.on('backup:completed', (info) => {
    console.log('âœ… Backup concluÃ­do:', info.path);
});

// Backup falhou
db.on('backup:failed', (error) => {
    console.error('âŒ Backup falhou:', error);
});

// Limpeza de backups
db.on('backup:cleanup', (deletedCount) => {
    console.log(`ðŸ§¹ ${deletedCount} backups antigos removidos`);
});
```

## Eventos de TransaÃ§Ã£o

```javascript
// TransaÃ§Ã£o iniciada
db.on('transaction:begin', (txInfo) => {
    console.log(`ðŸ”„ TransaÃ§Ã£o iniciada: ${txInfo.id}`);
});

// TransaÃ§Ã£o commitada
db.on('transaction:commit', (txInfo) => {
    console.log(`âœ… Commit: ${txInfo.id} (${txInfo.duration}ms)`);
});

// TransaÃ§Ã£o revertida
db.on('transaction:rollback', (txInfo) => {
    console.log(`âŒ Rollback: ${txInfo.id} - ${txInfo.reason}`);
});

// Deadlock detectado
db.on('transaction:deadlock', (txInfo) => {
    console.warn(`âš ï¸ Deadlock: ${txInfo.id}`);
});
```

## Eventos Personalizados

### Emitindo Eventos Customizados
```javascript
// Dentro de uma operaÃ§Ã£o customizada
class UserService {
    constructor(db) {
        this.db = db;
    }
    
    async createUser(userData) {
        // Emitir evento antes da criaÃ§Ã£o
        this.db.emit('user:creating', userData);
        
        const userId = `user:${Date.now()}`;
        await this.db.set(userId, userData);
        
        // Emitir evento apÃ³s criaÃ§Ã£o
        this.db.emit('user:created', userId, userData);
        
        return userId;
    }
}

// Escutando eventos customizados
db.on('user:creating', (userData) => {
    console.log('ðŸ‘¤ Criando usuÃ¡rio:', userData.name);
});

db.on('user:created', (userId, userData) => {
    console.log(`âœ… UsuÃ¡rio criado: ${userId}`);
    
    // AÃ§Ãµes pÃ³s-criaÃ§Ã£o
    sendWelcomeEmail(userData.email);
    logUserCreation(userId);
});
```

## Filtros e Middlewares

### Interceptar OperaÃ§Ãµes
```javascript
// Middleware para log de todas as operaÃ§Ãµes
db.on('*', (eventName, ...args) => {
    if (eventName.startsWith('performance')) return;
    
    console.log(`ðŸ“‹ Evento: ${eventName}`, args);
});

// Filter para operaÃ§Ãµes especÃ­ficas
db.addFilter('set', async (key, value, options) => {
    // ValidaÃ§Ã£o antes de salvar
    if (key.startsWith('user:') && !value.email) {
        throw new Error('Email Ã© obrigatÃ³rio para usuÃ¡rios');
    }
    
    // TransformaÃ§Ã£o de dados
    if (typeof value === 'object') {
        value.lastModified = new Date().toISOString();
    }
    
    return { key, value, options };
});
```

## Event Aggregation

### Agregador de Eventos
```javascript
class EventAggregator {
    constructor(db) {
        this.db = db;
        this.stats = {
            operations: 0,
            errors: 0,
            cacheHits: 0,
            cacheMisses: 0
        };
        
        this.setupListeners();
    }
    
    setupListeners() {
        // Contar operaÃ§Ãµes
        ['set', 'get', 'delete', 'has'].forEach(op => {
            this.db.on(op, () => this.stats.operations++);
        });
        
        // Contar erros
        this.db.on('error', () => this.stats.errors++);
        
        // EstatÃ­sticas de cache
        this.db.on('cache:hit', () => this.stats.cacheHits++);
        this.db.on('cache:miss', () => this.stats.cacheMisses++);
        
        // RelatÃ³rio periÃ³dico
        setInterval(() => this.report(), 60000); // 1 minuto
    }
    
    report() {
        const cacheHitRate = this.stats.cacheHits / 
            (this.stats.cacheHits + this.stats.cacheMisses);
            
        console.log('ðŸ“Š RelatÃ³rio de 1 minuto:', {
            ...this.stats,
            cacheHitRate: (cacheHitRate * 100).toFixed(2) + '%'
        });
        
        // Reset stats
        Object.keys(this.stats).forEach(key => this.stats[key] = 0);
    }
}

const aggregator = new EventAggregator(db);
```

## ConfiguraÃ§Ã£o AvanÃ§ada

```javascript
const db = new HelperDB({
    driver: 'sqlite',
    events: {
        enabled: true,
        maxListeners: 50,
        async: true,
        
        // Buffer de eventos para alta performance
        buffer: {
            enabled: true,
            maxSize: 1000,
            flushInterval: 5000,
            onFlush: (events) => {
                // Processar eventos em lote
                processEventsBatch(events);
            }
        },
        
        // Filtros globais
        filters: {
            // Filtrar eventos de sistema em produÃ§Ã£o
            production: (eventName) => {
                return !eventName.startsWith('performance');
            },
            
            // Filtrar por chaves sensÃ­veis
            security: (eventName, key) => {
                return !key?.includes('password');
            }
        },
        
        // Rate limiting
        rateLimit: {
            enabled: true,
            maxEventsPerSecond: 1000,
            onLimit: (eventName, count) => {
                console.warn(`Rate limit atingido para ${eventName}: ${count}/s`);
            }
        }
    }
});
```

## Exemplo Completo - Sistema de Monitoramento

```javascript
class DatabaseMonitor {
    constructor(db) {
        this.db = db;
        this.metrics = {
            operations: new Map(),
            errors: [],
            slowQueries: [],
            cacheStats: { hits: 0, misses: 0 }
        };
        
        this.setupMonitoring();
    }
    
    setupMonitoring() {
        // Monitorar todas as operaÃ§Ãµes
        ['set', 'get', 'delete', 'has', 'add', 'sub'].forEach(op => {
            this.db.on(op, (...args) => {
                this.recordOperation(op, args);
            });
        });
        
        // Monitorar performance
        this.db.on('performance', (stats) => {
            if (stats.duration > 100) { // > 100ms Ã© lento
                this.recordSlowQuery(stats);
            }
        });
        
        // Monitorar erros
        this.db.on('error', (error) => {
            this.recordError(error);
        });
        
        // Monitorar cache
        this.db.on('cache:hit', () => this.metrics.cacheStats.hits++);
        this.db.on('cache:miss', () => this.metrics.cacheStats.misses++);
        
        // Monitorar transaÃ§Ãµes
        this.db.on('transaction:rollback', (txInfo) => {
            console.warn(`âš ï¸ TransaÃ§Ã£o revertida: ${txInfo.reason}`);
        });
        
        // RelatÃ³rio periÃ³dico
        setInterval(() => this.generateReport(), 300000); // 5 minutos
    }
    
    recordOperation(operation, args) {
        const count = this.metrics.operations.get(operation) || 0;
        this.metrics.operations.set(operation, count + 1);
    }
    
    recordSlowQuery(stats) {
        this.metrics.slowQueries.push({
            ...stats,
            timestamp: new Date().toISOString()
        });
        
        // Manter apenas os Ãºltimos 100
        if (this.metrics.slowQueries.length > 100) {
            this.metrics.slowQueries.shift();
        }
    }
    
    recordError(error) {
        this.metrics.errors.push({
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
        });
        
        // Manter apenas os Ãºltimos 50 erros
        if (this.metrics.errors.length > 50) {
            this.metrics.errors.shift();
        }
    }
    
    generateReport() {
        const { hits, misses } = this.metrics.cacheStats;
        const cacheHitRate = hits / (hits + misses) || 0;
        
        const report = {
            timestamp: new Date().toISOString(),
            operations: Object.fromEntries(this.metrics.operations),
            totalOperations: Array.from(this.metrics.operations.values())
                .reduce((sum, count) => sum + count, 0),
            errorCount: this.metrics.errors.length,
            slowQueryCount: this.metrics.slowQueries.length,
            cacheHitRate: (cacheHitRate * 100).toFixed(2) + '%',
            recentErrors: this.metrics.errors.slice(-5),
            slowestQueries: this.metrics.slowQueries
                .sort((a, b) => b.duration - a.duration)
                .slice(0, 5)
        };
        
        console.log('ðŸ“Š RelatÃ³rio do Database:', report);
        
        // Alertas
        if (cacheHitRate < 0.8) {
            console.warn('âš ï¸ Taxa de cache hit baixa:', cacheHitRate);
        }
        
        if (this.metrics.errors.length > 10) {
            console.error('ðŸš¨ Muitos erros detectados:', this.metrics.errors.length);
        }
        
        // Reset metrics
        this.metrics.operations.clear();
        this.metrics.cacheStats = { hits: 0, misses: 0 };
    }
}

// Inicializar monitoramento
const monitor = new DatabaseMonitor(db);
```
